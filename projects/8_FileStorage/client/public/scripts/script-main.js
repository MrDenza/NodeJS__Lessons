import{r as c,j as n,c as E}from"./script-n-modules.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))u(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&u(s)}).observe(document,{childList:!0,subtree:!0});function l(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function u(o){if(o.ep)return;o.ep=!0;const r=l(o);fetch(o.href,r)}})();function I({isLoading:t,progress:e,children:l,...u}){return n.jsxs("button",{...u,disabled:t,style:{position:"relative",overflow:"hidden"},children:[t&&n.jsx("div",{className:"btn_progress-fill",style:{width:`${e}%`}}),n.jsx("span",{style:{position:"relative",zIndex:1},children:t?"Загрузка...":l})]})}const L=c.memo(I);function R({sendForm:t,progress:e,isLoading:l}){const[u,o]=c.useState(""),[r,s]=c.useState(""),m=f=>{f.preventDefault();const p=f.target,{files:a}=f.target.elements.file,y=f.target.elements.comment.value,h=a.length===0?"Файл не выбран!":"",g=y.length>100?"Максимальная длина 100 символов!":"";o(h),s(g),!h&&!g&&t(p)};return n.jsxs("form",{onSubmit:m,className:"app__form-box",children:[n.jsx("label",{htmlFor:"i-file",title:"Выбор файла",className:"app__form-title-file",children:"Выберите файл:"}),n.jsx("input",{id:"i-file",type:"file",name:"file",className:"app__form-btn-file"}),n.jsx("span",{className:"app__form-text-err",children:u}),n.jsx("label",{htmlFor:"i-text",title:"Комментарии к файлу",className:"app__form-title-text",children:"Введите комментарий:"}),n.jsx("input",{id:"i-text",type:"text",placeholder:"*При необходимости*",name:"comment",className:"app__form-input-text"}),n.jsx("span",{className:"app__form-text-err",children:r}),n.jsx(L,{type:"submit",className:"app__form-btn-send",isLoading:l,progress:e,children:"Загрузить"})]})}const O=c.memo(R),U="",_=async(t,e={},l={})=>{const{accept:u="application/json",headers:o={},contentType:r}=l,s=new Headers({Accept:u,...o});let m;e instanceof FormData?m=e:e instanceof Blob||e instanceof File?(m=e,r?s.set("Content-Type",r):s.has("Content-Type")):typeof e=="string"?(m=e,r?s.set("Content-Type",r):s.has("Content-Type")||s.set("Content-Type","text/plain;charset=UTF-8")):e&&typeof e=="object"?(m=JSON.stringify(e),r?s.set("Content-Type",r):s.has("Content-Type")||s.set("Content-Type","application/json;charset=UTF-8")):m=null;const f=await fetch(`${U}${t}`,{method:"POST",headers:s,body:m}),p=f.headers.get("Content-Type")||"";let a;if(p.includes("application/json")?a=await f.json():p.startsWith("text/")?a=await f.text():p.includes("application/octet-stream")||p.includes("application/pdf")||p.startsWith("image/")||p.startsWith("audio/")||p.startsWith("video/")?a=await f.blob():a=await f.text(),!f.ok){const y=a&&typeof a=="object"&&a.error?a.error:f.statusText||"Unknown error",h=new Error(y);throw h.status=f.status,h.body=a,h}return a},A=t=>t<1024?t+" Б":t<1024*1024?(t/1024).toFixed(2)+" КБ":t<1024*1024*1024?(t/(1024*1024)).toFixed(2)+" МБ":(t/(1024*1024*1024)).toFixed(2)+" ГБ";function P({file:t,handleDownload:e}){const{fileName:l,fileSize:u,fileDateAdded:o,fileComment:r}=t,s=new Date(o).toLocaleString();return n.jsxs("div",{className:"app__file-item",children:[n.jsxs("div",{className:"app__file-item-box",children:[n.jsxs("div",{children:[n.jsx("img",{src:"/file-icon.png",alt:`Скачать файл ${l}`,tabIndex:0,role:"button",className:"app__file-item-img",onClick:()=>e(l)}),n.jsx("span",{className:"app__file-info-size",children:A(u)})]}),n.jsxs("div",{className:"app__file-info-box",children:[n.jsx("span",{className:"app__file-info-name",children:l}),n.jsx("span",{children:s})]})]}),n.jsxs("div",{className:"app__file-comment",children:[n.jsx("b",{children:"Комментарий: "}),r]})]})}const k=c.memo(P);function D({fileList:t,downloadFile:e}){const l=c.useCallback(o=>{e(o)},[e]),u=c.useMemo(()=>[...t].sort((o,r)=>new Date(r.fileDateAdded)-new Date(o.fileDateAdded)),[t]);return n.jsx("div",{className:"app__file-list-box",children:u.map(o=>n.jsx(k,{file:o,handleDownload:l},o.fileName))})}const $=c.memo(D),F={sendFile:"/upload",sessionInfo:"/session-info",downloadFile:"/download"},M=5,W=3e3;function C(t){return Object.fromEntries(Object.entries(t).filter(([,e])=>e!=null&&e!==""))}function B(t,e){const l=document.createElement("a");l.href=t,l.download=e,document.body.appendChild(l),l.click(),setTimeout(()=>{URL.revokeObjectURL(l.href),document.body.removeChild(l)},100)}function N(t){if(t!=null)return encodeURIComponent(String(t))}function H(){const[t,e]=c.useState(0),[l,u]=c.useState(!1),[o,r]=c.useState([]),[s,m]=c.useState(()=>localStorage.getItem("uid")||null),[f,p]=c.useState(null),a=c.useRef(null),y=c.useRef(0),h=c.useRef(null),g=c.useCallback(()=>{!s||!f||(a.current=new WebSocket(f),a.current.onopen=()=>{y.current=0,console.log("WebSocket соединение установлено!"),s&&a.current.send(JSON.stringify({type:"register",uid:s}))},a.current.onmessage=i=>{let d;try{d=JSON.parse(i.data)}catch{console.log(i.data);return}typeof d=="object"&&d!==null&&d.type==="uploadProgress"?e(d.progress):typeof d=="string"&&console.log(d)},a.current.onclose=()=>{console.log("WebSocket соединение закрыто!"),y.current<M&&(y.current++,h.current=setTimeout(()=>{console.log(`Попытка переподключения #${y.current}`),g()},W))},a.current.onerror=i=>{console.error("Ошибка WebSocket: ",i),a.current.close()})},[s,f]),T=i=>{m(i),i?localStorage.setItem("uid",i):localStorage.removeItem("uid")},w=c.useCallback(async()=>{try{const i={"Content-Type":"application/json",...s?{"x-user-uid":N(s)}:{}},d=await _(F.sessionInfo,{},{headers:i});d.status==="success"&&(T(d.uid),r(d.files),p(d.wsUrl))}catch(i){console.error("Ошибка инициализации: ",i)}},[s]),S=c.useCallback(async i=>{const d=i.elements.file.files[0],x=i.elements.comment.value;e(0),u(!0);const j=C({"x-user-uid":N(s),"x-file-comment":x?encodeURIComponent(x):void 0,"x-file-name":d!=null&&d.name?encodeURIComponent(d.name):void 0});try{const b=await _(F.sendFile,d,{headers:j});b.status==="success"&&(console.log("Файл успешно загружен!"),r(b.fileList),e(100),i.reset())}catch(b){console.error("Ошибка при загрузке файла:",b),e(0),u(!1)}},[s]),v=c.useCallback(async i=>{const d=C({"x-user-uid":N(s)});try{const x=await _(F.downloadFile,{type:"downloadFile",fileName:i},{headers:d});console.log("Скачивание файла: ",i);let j;x instanceof Blob?j=x:typeof x=="string"&&(j=new Blob([x],{type:"text/plain"}));const b=URL.createObjectURL(j);B(b,i)}catch(x){console.error(`Ошибка при скачивании файла ${i}: `,x)}},[s]);return c.useEffect(()=>{(async()=>await w())()},[w]),c.useEffect(()=>{if(s)return g(),()=>{h.current&&clearTimeout(h.current),a.current&&a.current.close()}},[g,s]),c.useEffect(()=>{if(t===100){const i=setTimeout(()=>{e(0),u(!1)},300);return()=>clearTimeout(i)}},[t]),n.jsx("div",{className:"container",children:n.jsxs("div",{className:"app__box",children:[n.jsx("h1",{className:"app__title",children:"FreeCloud"}),n.jsx(O,{sendForm:S,progress:t,isLoading:l}),n.jsx("hr",{}),n.jsx($,{fileList:o,downloadFile:v})]})})}E.createRoot(document.getElementById("root")).render(n.jsx(H,{}));
