import{r as c,j as o,c as U}from"./script-n-modules.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))d(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&d(a)}).observe(document,{childList:!0,subtree:!0});function l(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function d(s){if(s.ep)return;s.ep=!0;const n=l(s);fetch(s.href,n)}})();function O({isLoading:e,progress:t,children:l,...d}){return o.jsxs("button",{...d,disabled:e,style:{position:"relative",overflow:"hidden"},children:[e&&o.jsx("div",{className:"btn_progress-fill",style:{width:`${t}%`}}),o.jsx("span",{style:{position:"relative",zIndex:1},children:e?"Загрузка...":l})]})}const k=c.memo(O);function W({sendForm:e,progress:t,isLoading:l}){const[d,s]=c.useState(""),[n,a]=c.useState(""),x=r=>{r.preventDefault();const g=r.target,{files:f}=r.target.elements.file,S=r.target.elements.comment.value,h=f.length===0?"Файл не выбран!":"",_=S.length>100?"Максимальная длина 100 символов!":"";s(h),a(_),!h&&!_&&e(g)};return o.jsxs("form",{onSubmit:x,className:"app__form-box",children:[o.jsx("label",{htmlFor:"i-file",title:"Выбор файла",className:"app__form-title-file",children:"Выберите файл:"}),o.jsx("input",{id:"i-file",type:"file",name:"file",className:"app__form-btn-file"}),o.jsx("span",{className:"app__form-text-err",children:d}),o.jsx("label",{htmlFor:"i-text",title:"Комментарии к файлу",className:"app__form-title-text",children:"Введите комментарий:"}),o.jsx("input",{id:"i-text",type:"text",placeholder:"*При необходимости*",name:"comment",className:"app__form-input-text"}),o.jsx("span",{className:"app__form-text-err",children:n}),o.jsx(k,{type:"submit",className:"app__form-btn-send",isLoading:l,progress:t,children:"Загрузить"})]})}const P=c.memo(W),M="",N=async(e,t={},l={})=>{const{accept:d="application/json",headers:s={},contentType:n}=l,a=new Headers({Accept:d,...s});let x;t instanceof FormData?x=t:t instanceof Blob||t instanceof File?(x=t,n?a.set("Content-Type",n):a.has("Content-Type")):typeof t=="string"?(x=t,n?a.set("Content-Type",n):a.has("Content-Type")||a.set("Content-Type","text/plain;charset=UTF-8")):t&&typeof t=="object"?(x=JSON.stringify(t),n?a.set("Content-Type",n):a.has("Content-Type")||a.set("Content-Type","application/json;charset=UTF-8")):x=null;const r=await fetch(`${M}${e}`,{method:"POST",headers:a,body:x}),g=r.headers.get("Content-Type")||"";let f;if(g.includes("application/json")?f=await r.json():g.startsWith("text/")?f=await r.text():g.includes("application/octet-stream")||g.includes("application/pdf")||g.startsWith("image/")||g.startsWith("audio/")||g.startsWith("video/")?f=await r.blob():f=await r.text(),!r.ok){const S=f&&typeof f=="object"&&f.error?f.error:r.statusText||"Unknown error",h=new Error(S);throw h.status=r.status,h.body=f,h}return f},$=e=>e<1024?e+" Б":e<1024*1024?(e/1024).toFixed(2)+" КБ":e<1024*1024*1024?(e/(1024*1024)).toFixed(2)+" МБ":(e/(1024*1024*1024)).toFixed(2)+" ГБ";function D({file:e,handleDownload:t}){const{fileName:l,fileSize:d,fileDateAdded:s,fileComment:n}=e,a=new Date(s).toLocaleString();return o.jsxs("div",{className:"app__file-item",children:[o.jsxs("div",{className:"app__file-item-box",children:[o.jsxs("div",{children:[o.jsx("img",{src:"/file-icon.png",alt:`Скачать файл ${l}`,tabIndex:0,role:"button",className:"app__file-item-img",onClick:()=>t(l)}),o.jsx("span",{className:"app__file-info-size",children:$(d)})]}),o.jsxs("div",{className:"app__file-info-box",children:[o.jsx("span",{className:"app__file-info-name",children:l}),o.jsx("span",{children:a})]})]}),o.jsxs("div",{className:"app__file-comment",children:[o.jsx("b",{children:"Комментарий: "}),n]})]})}const A=c.memo(D);function B({fileList:e,downloadFile:t}){const l=c.useCallback(s=>{t(s)},[t]),d=c.useMemo(()=>[...e].sort((s,n)=>new Date(n.fileDateAdded)-new Date(s.fileDateAdded)),[e]);return o.jsx("div",{className:"app__file-list-box",children:d.map(s=>o.jsx(A,{file:s,handleDownload:l},s.fileName))})}const H=c.memo(B),F={sendFile:"/upload",sessionInfo:"/session-info",downloadFile:"/download"},J=3,K=3e3;function E(e){return Object.fromEntries(Object.entries(e).filter(([,t])=>t!=null&&t!==""))}function V(e,t){const l=document.createElement("a");l.href=e,l.download=t,document.body.appendChild(l),l.click(),setTimeout(()=>{URL.revokeObjectURL(l.href),document.body.removeChild(l)},100)}function T(e){if(e!=null)return encodeURIComponent(String(e))}const X=e=>{try{return JSON.parse(e.data)}catch{return console.log(e.data),null}};function q(){const[e,t]=c.useState(0),[l,d]=c.useState(!1),[s,n]=c.useState(""),[a,x]=c.useState([]),[r,g]=c.useState(()=>localStorage.getItem("uid")||null),[f,S]=c.useState(null),h=c.useRef(null),_=c.useRef(!0),w=c.useCallback((i=3,p=3e3,u=1)=>new Promise((m,y)=>{const b=new WebSocket(f),j=setTimeout(()=>{b.close(),u<i?(console.log(`[WebSocket] Попытка подключения #${u} не удалась, пробуем снова...`),m(w(i,u+1))):y(new Error("Не удалось установить соединение с сервером (3 попытки)."))},p);b.onopen=()=>{clearTimeout(j),console.log("[WebSocket] Соединение установлено."),r&&b.send(JSON.stringify({type:"register",uid:r})),m(b)},b.onerror=R=>{console.error("[WebSocket] Ошибка:",R),b.close()},b.onclose=()=>{clearTimeout(j),_.current&&(u<i?(console.log(`[WebSocket] Соединение закрыто, попытка #${u} не удалась, повторяем...`),m(w(i,p,u+1))):y(new Error("Не удалось установить соединение с сервером.")))}}),[r,f]),I=i=>{g(i),i?localStorage.setItem("uid",i):localStorage.removeItem("uid")},C=c.useCallback(async()=>{try{const i={"Content-Type":"application/json",...r?{"x-user-uid":T(r)}:{}},p=await N(F.sessionInfo,{},{headers:i});p.status==="success"&&(I(p.uid),x(p.files),S(p.wsUrl))}catch(i){console.error("Ошибка инициализации: ",i)}},[r]),v=c.useCallback(async i=>{const p=i.elements.file.files[0],u=i.elements.comment.value;if(t(0),d(!0),!r||!f){console.error("[WebSocket] Невозможно открыть соединение."),d(!1);return}_.current=!0;try{h.current=await w(J,K),h.current.onmessage=b=>{const j=X(b);j.type==="uploadProgress"&&t(j.progress),j.type==="endUpload"&&(_.current=!1,h.current&&(h.current.close(),h.current=null))},n("");const m=E({"x-user-uid":T(r),"x-file-comment":u?encodeURIComponent(u):void 0,"x-file-name":p!=null&&p.name?encodeURIComponent(p.name):void 0}),y=await N(F.sendFile,p,{headers:m});y.status==="success"&&(console.log("Файл успешно загружен!"),x(y.fileList),t(100),i.reset())}catch(m){console.error("Ошибка при загрузке файла: ",m),n(/^[А-Яа-яЁё]/.test(String(m).trim())?`Ошибка: ${m}`:"Ошибка отправки файла!"),t(0),d(!1)}},[w,r,f]),L=c.useCallback(async i=>{const p=E({"x-user-uid":T(r)});try{const u=await N(F.downloadFile,{type:"downloadFile",fileName:i},{headers:p});console.log("Скачивание файла: ",i);let m;u instanceof Blob?m=u:typeof u=="string"&&(m=new Blob([u],{type:"text/plain"}));const y=URL.createObjectURL(m);V(y,i)}catch(u){console.error(`Ошибка при скачивании файла ${i}: `,u)}},[r]);return c.useEffect(()=>{(async()=>await C())()},[C]),c.useEffect(()=>{if(e===100){const i=setTimeout(()=>{t(0),d(!1)},300);return()=>clearTimeout(i)}},[e]),c.useEffect(()=>{if(s.trim().length>0){const i=setTimeout(()=>{n("")},7e3);return()=>clearTimeout(i)}},[s]),o.jsx("div",{className:"container",children:o.jsxs("div",{className:"app__box",children:[o.jsx("h1",{className:"app__title",children:"FreeCloud"}),o.jsx(P,{sendForm:v,progress:e,isLoading:l}),o.jsx("span",{className:"app__err-msg",children:s}),o.jsx("hr",{}),o.jsx(H,{fileList:a,downloadFile:L})]})})}U.createRoot(document.getElementById("root")).render(o.jsx(q,{}));
