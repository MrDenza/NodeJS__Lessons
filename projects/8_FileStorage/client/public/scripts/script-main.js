import{j as s,r as f,c as T}from"./script-n-modules.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))d(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&d(r)}).observe(document,{childList:!0,subtree:!0});function c(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function d(t){if(t.ep)return;t.ep=!0;const n=c(t);fetch(t.href,n)}})();function S({isLoading:o,progress:e,children:c,...d}){return s.jsxs("button",{...d,disabled:o,style:{position:"relative",overflow:"hidden"},children:[o&&s.jsx("div",{className:"btn_progress-fill",style:{width:`${e}%`}}),s.jsx("span",{style:{position:"relative",zIndex:1},children:o?"Загрузка...":c})]})}function C({sendForm:o,progress:e,isLoading:c}){const[d,t]=f.useState(""),[n,r]=f.useState(""),g=a=>{a.preventDefault();const m=a.target,{files:i}=a.target.elements.file,j=a.target.elements.comment.value,y=i.length===0?"Файл не выбран!":"",_=j.length>100?"Максимальная длина 100 символов!":"";t(y),r(_),!y&&!_&&o(m)};return s.jsxs("form",{onSubmit:g,className:"app__form-box",children:[s.jsx("label",{htmlFor:"i-file",title:"Выбор файла",className:"app__form-title-file",children:"Выберите файл:"}),s.jsx("input",{id:"i-file",type:"file",name:"file",className:"app__form-btn-file"}),s.jsx("span",{className:"app__form-text-err",children:d}),s.jsx("label",{htmlFor:"i-text",title:"Комментарии к файлу",className:"app__form-title-text",children:"Введите комментарий:"}),s.jsx("input",{id:"i-text",type:"text",placeholder:"*При необходимости*",name:"comment",className:"app__form-input-text"}),s.jsx("span",{className:"app__form-text-err",children:n}),s.jsx(S,{type:"submit",className:"app__form-btn-send",isLoading:c,progress:e,children:"Загрузить"})]})}const I=f.memo(C),v="",F=async(o,e={},c={})=>{const{accept:d="application/json",headers:t={},contentType:n}=c,r=new Headers({Accept:d,...t});let g;e instanceof FormData?g=e:e instanceof Blob||e instanceof File?(g=e,n?r.set("Content-Type",n):r.has("Content-Type")):typeof e=="string"?(g=e,n?r.set("Content-Type",n):r.has("Content-Type")||r.set("Content-Type","text/plain;charset=UTF-8")):e&&typeof e=="object"?(g=JSON.stringify(e),n?r.set("Content-Type",n):r.has("Content-Type")||r.set("Content-Type","application/json;charset=UTF-8")):g=null;const a=await fetch(`${v}${o}`,{method:"POST",headers:r,body:g}),m=a.headers.get("Content-Type")||"";let i;if(m.includes("application/json")?i=await a.json():m.startsWith("text/")?i=await a.text():m.includes("application/octet-stream")||m.includes("application/pdf")||m.startsWith("image/")||m.startsWith("audio/")||m.startsWith("video/")?i=await a.blob():i=await a.text(),!a.ok){const j=i&&typeof i=="object"&&i.error?i.error:a.statusText||"Unknown error",y=new Error(j);throw y.status=a.status,y.body=i,y}return i},E=o=>o<1024?o+" Б":o<1024*1024?(o/1024).toFixed(2)+" КБ":o<1024*1024*1024?(o/(1024*1024)).toFixed(2)+" МБ":(o/(1024*1024*1024)).toFixed(2)+" ГБ";function U({file:o,handleDownload:e}){const{fileName:c,fileSize:d,fileDateAdded:t,fileComment:n}=o,r=new Date(t).toLocaleString();return s.jsxs("div",{className:"app__file-item",children:[s.jsxs("div",{className:"app__file-item-box",children:[s.jsxs("div",{children:[s.jsx("img",{src:"/file-icon.png",alt:`Скачать файл ${c}`,tabIndex:0,role:"button",className:"app__file-item-img",onClick:()=>e(c)}),s.jsx("span",{className:"app__file-info-size",children:E(d)})]}),s.jsxs("div",{className:"app__file-info-box",children:[s.jsx("span",{className:"app__file-info-name",children:c}),s.jsx("span",{children:r})]})]}),s.jsxs("div",{className:"app__file-comment",children:[s.jsx("b",{children:"Комментарий: "}),n]})]})}const L=f.memo(U);function R({fileList:o,downloadFile:e}){const c=f.useCallback(t=>{e(t)},[e]),d=f.useMemo(()=>[...o].sort((t,n)=>new Date(n.fileDateAdded)-new Date(t.fileDateAdded)),[o]);return s.jsx("div",{className:"app__file-list-box",children:d.map(t=>s.jsx(L,{file:t,handleDownload:c},t.fileName))})}const O=f.memo(R),N={sendFile:"/upload",sessionInfo:"/session-info",downloadFile:"/download"},A=5,P=3e3;function w(o){return Object.fromEntries(Object.entries(o).filter(([,e])=>e!=null&&e!==""))}function D(o,e){const c=document.createElement("a");c.href=o,c.download=e,c.click(),URL.revokeObjectURL(c.href)}function M(){const[o,e]=f.useState(0),[c,d]=f.useState(!1),[t,n]=f.useState([]),[r,g]=f.useState(null),[a,m]=f.useState(null),i=f.useRef(null);f.useEffect(()=>{j()},[]),f.useEffect(()=>{if(!r)return;let l=0,u;function p(){!r||!a||(i.current=new WebSocket(a),i.current.onopen=()=>{l=0,console.log("WebSocket соединение установлено!"),r&&i.current.send(JSON.stringify({type:"register",uid:r}))},i.current.onmessage=h=>{let x;try{x=JSON.parse(h.data)}catch{console.log(h.data);return}typeof x=="object"&&x!==null&&x.type==="uploadProgress"?e(x.progress):typeof x=="string"&&console.log(x)},i.current.onclose=()=>{console.log("WebSocket соединение закрыто!"),l<A&&(l++,u=setTimeout(()=>{console.log(`Попытка переподключения #${l}`),p()},P))},i.current.onerror=h=>{console.error("Ошибка WebSocket: ",h),i.current.close()})}return p(),()=>{clearTimeout(u),i.current&&i.current.close()}},[r,a]),f.useEffect(()=>{if(o===100){const l=setTimeout(()=>{e(0),d(!1)},300);return()=>clearTimeout(l)}},[o]);const j=()=>{const l=localStorage.getItem("uid"),u={"Content-Type":"application/json"};l&&(u["x-user-uid"]=encodeURIComponent(l)),F(N.sessionInfo,{},{headers:u}).then(p=>{p.status==="success"&&(localStorage.setItem("uid",p.uid),n(p.files),g(p.uid),m(p.wsUrl))}).catch(p=>{console.error("Ошибка инициализации: ",p)})},y=async l=>{const u=l.elements.file.files[0],p=l.elements.comment.value,h=localStorage.getItem("uid");e(0),d(!0);const x=w({"x-user-uid":h?encodeURIComponent(h):void 0,"x-file-comment":p?encodeURIComponent(p):void 0,"x-file-name":u!=null&&u.name?encodeURIComponent(u.name):void 0});await F(N.sendFile,u,{headers:x}).then(b=>{b.status==="success"&&(console.log("Файл успешно загружен!"),n(b.fileList),e(100),l.reset())}).catch(b=>{console.error("Ошибка при загрузке файла:",b),e(0),d(!1)})},_=async l=>{const u=localStorage.getItem("uid"),p=w({"x-user-uid":u?encodeURIComponent(u):void 0});await F(N.downloadFile,{type:"downloadFile",fileName:l},{headers:p}).then(h=>{console.log("Скачивание файла: ",l);const x=URL.createObjectURL(h);D(x,l)}).catch(h=>{console.error(`Ошибка при скачивании файла ${l}: `,h)})};return s.jsx("div",{className:"container",children:s.jsxs("div",{className:"app__box",children:[s.jsx("h1",{className:"app__title",children:"FreeCloud"}),s.jsx(I,{sendForm:y,progress:o,isLoading:c}),s.jsx("hr",{}),s.jsx(O,{fileList:t,downloadFile:_})]})})}T.createRoot(document.getElementById("root")).render(s.jsx(M,{}));
